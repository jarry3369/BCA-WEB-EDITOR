(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&c(u)}).observe(document,{childList:!0,subtree:!0});function o(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerPolicy&&(i.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?i.credentials="include":e.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function c(e){if(e.ep)return;e.ep=!0;const i=o(e);fetch(e.href,i)}})();const I=document.getElementById("nicknameLayer"),m=document.getElementById("nicknameInput"),E=document.getElementById("joinButton"),h=document.getElementById("editor"),a=document.getElementById("content"),C=document.getElementById("participants"),b=document.getElementById("noticeMessage"),v=new BroadcastChannel("simple_web_text_editor");function d(n,t){v.postMessage({type:n,...t})}let s=[];const B=function(){const t=document.createElement("canvas").getContext("2d");return o=>t?(t.font=window.getComputedStyle(a).font,t.measureText(o).width):0}();function w(n){b.innerHTML=n}function g(){C.innerHTML=s.map(n=>n.nickname).join("<br/>")}function x(){const n=m.value.trim();if(n){I.classList.add("hidden"),h.classList.remove("hidden");const t=a.selectionStart,o={id:Date.now().toString(),nickname:n,cursorPosition:t};k(o),d("join",{participant:o})}}function N(){d("getParticipants",{}),d("getContent",{}),a.addEventListener("input",()=>{const n=a.value;d("content",{content:n});const t=a.selectionStart,o=m.value.trim(),c=s.find(e=>e.nickname===o);c&&d("cursorPosition",{participantId:c.id,cursorPosition:t})})}function k(n){w(`${n.nickname}님이 입장하였습니다.`),s.push(n),g(),O()}function S(n){var e;const t=n.data,o=t.participantId,c=m.value.trim();switch(t.type){case"join":const i=t.participant;k(i);break;case"content":((e=s.find(r=>r.id===t.participantId))==null?void 0:e.nickname)!==c&&(a.value=t.content);break;case"leave":const f=s.findIndex(r=>r.id===o);if(f!==-1){s.splice(f,1),g();const r=document.getElementById(`cursor_${o}`);r&&r.remove()}break;case"getParticipants":d("participantsList",{participants:s});break;case"participantsList":s=t.participants,g(),y();break;case"cursorPosition":const p=t.cursorPosition,l=s.find(r=>r.id===o);l&&(l.cursorPosition=p,l.nickname===c&&y());break}y()}function M(n){let t=document.getElementById(`cursor_${n.id}`);t||(t=document.createElement("span"),t.id=`cursor_${n.id}`,t.classList.add("cursorLabel"),t.textContent=n.nickname,h.appendChild(t));const o=n.cursorPosition,c=a.value,e=c.substring(0,o),i=(e.match(/\n/g)||[]).length,f=c.split(`
`)[i],p=e.lastIndexOf(`
`),l=p===-1?o:o-p-1,r=16,L=a.offsetTop+r*i,P=a.offsetLeft+B(f.slice(0,l));t.style.position="absolute",t.style.top=`${L-20}px`,t.style.left=`${P+5}px`,t.style.width="fit-content"}function O(){const n=a.selectionStart;d("cursorPosition",{participants:s,cursorPosition:n})}function y(){const n=m.value.trim(),t=s.find(e=>e.nickname===n),o=new Set(s.map(e=>`cursor_${e.id}`)),c=h.getElementsByClassName("cursorLabel");for(let e=c.length-1;e>=0;e--){const i=c[e];o.has(i.id)||i.remove()}s.forEach(e=>{(!t||e.id!==t.id)&&M(e)})}document.addEventListener("DOMContentLoaded",()=>{v.onmessage=S,E.addEventListener("click",x),N()});window.addEventListener("beforeunload",()=>{const n=m.value.trim(),t=s.find(o=>o.nickname===n);t&&(s=s.filter(o=>o.nickname!==n),g(),d("leave",{participantId:t.id}))});
